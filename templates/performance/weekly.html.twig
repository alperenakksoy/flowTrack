{% extends 'base.html.twig' %}

{% block title %}Weekly Performance Report{% endblock %}

{% block body %}
    {# Set shortcut variables for easier access #}
    {% set taskMetrics = metrics.taskMetrics %}
    {% set taskBasics = metrics.taskMetrics.basicMetrics %}
    {% set taskTime = metrics.taskMetrics.timeMetrics %}
    {% set taskPriority = metrics.taskMetrics.priorityMetrics %}
    {% set goalMetrics = metrics.goalMetrics %}

    <div class="container">
        {# Header Section #}
        <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h1>Weekly Performance Report</h1>
                <p class="text-muted mb-0">Week {{ week }} - {{ year }}</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ path('performance_overall') }}" class="btn btn-success">
                    Overall Report
                </a>
                <a href="{{ path('performance_monthly') }}" class="btn btn-primary">
                    Monthly Report
                </a>
            </div>
        </div>

        {# Combined Score Hero Section #}
        <div class="text-center text-white bg-primary bg-gradient rounded-3 shadow-lg p-5 mb-5">
            <h2 class="fw-light mb-4">Combined Weekly Performance Score</h2>
            <div class="display-1 fw-bold mb-4">{{ combinedScore|number_format(1) }}%</div>

            {% set scoreLevel = combinedScore %}
            <div class="fs-5 mb-4">
                {% if scoreLevel >= 90 %}
                    <span class="badge rounded-pill fs-6 fw-normal bg-light text-primary p-3">
                        üåü Outstanding Week
                    </span>
                {% elseif scoreLevel >= 75 %}
                    <span class="badge rounded-pill fs-6 fw-normal bg-light text-primary p-3">
                        üëç Strong Week
                    </span>
                {% elseif scoreLevel >= 60 %}
                    <span class="badge rounded-pill fs-6 fw-normal bg-light text-primary p-3">
                        ‚ö†Ô∏è Developing Week
                    </span>
                {% else %}
                    <span class="badge rounded-pill fs-6 fw-normal bg-light text-primary p-3">
                        üìà Growth Opportunity
                    </span>
                {% endif %}
            </div>

            {# Task & Goal Score Breakdown #}
            <div class="row row-cols-1 row-cols-md-2 g-4 mt-4">
                <div class="col">
                    <div class="p-3 bg-light bg-opacity-25 rounded-3">
                        <div class="small">Task Performance</div>
                        <div class="display-4 fw-bold">{{ taskScore|number_format(1) }}%</div>
                    </div>
                </div>
                <div class="col">
                    <div class="p-3 bg-light bg-opacity-25 rounded-3">
                        <div class="small">Goal Performance</div>
                        <div class="display-4 fw-bold">{{ goalScore|number_format(1) }}%</div>
                    </div>
                </div>
            </div>
        </div>

        {# Task Overview Cards #}
        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-4 g-4 mb-5">
            <div class="col">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <div class="text-muted small mb-2">Total Tasks</div>
                        <div class="h1 fw-bold text-primary">{{ taskBasics.totalTasksInPeriod }}</div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <div class="text-muted small mb-2">Completed</div>
                        <div class="h1 fw-bold text-success">{{ taskBasics.completedTasks }}</div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <div class="text-muted small mb-2">Completion Rate</div>
                        <div class="h1 fw-bold text-primary">{{ taskBasics.taskCompletionRate|number_format(1) }}%</div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <div class="text-muted small mb-2">On-Time Rate</div>
                        <div class="h1 fw-bold text-info">{{ taskBasics.onTimeCompletionRate }}%</div>
                    </div>
                </div>
            </div>
        </div>

        {# Performance Breakdown #}
        <div class="row row-cols-1 row-cols-lg-2 g-5 mb-5">

            {# Task Performance Section #}
            <div class="col">
                <div class="card shadow-sm h-100">
                    <div class="card-body p-4">
                        <h3 class="mb-4 d-flex align-items-center">
                            <span class="me-2">üìã</span> Task Performance
                        </h3>

                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center p-3 bg-primary-subtle rounded mb-3">
                                <span class="fw-semibold">Total Tasks</span>
                                <span class="h4 fw-bold text-primary mb-0">{{ taskBasics.totalTasksInPeriod }}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center p-3 bg-success-subtle rounded mb-3">
                                <span class="fw-semibold">Completed</span>
                                <span class="h4 fw-bold text-success mb-0">{{ taskBasics.completedTasks }}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center p-3 bg-info-subtle rounded">
                                <span class="fw-semibold">On-Time</span>
                                <span class="h4 fw-bold text-info mb-0">{{ taskBasics.tasksCompletedOnTime }}</span>
                            </div>
                        </div>

                        {# Progress Bar #}
                        <div class="mt-4">
                            <div class="d-flex justify-content-between">
                                <span class="small fw-semibold text-primary">Task Completion Progress</span>
                                <span class="small fw-semibold text-primary">{{ taskBasics.taskCompletionRate|number_format(1) }}%</span>
                            </div>
                            <div class="progress" role="progressbar" aria-label="Task Completion" aria-valuenow="{{ taskBasics.taskCompletionRate }}" aria-valuemin="0" aria-valuemax="100" style="height: 1rem">
                                <div class="progress-bar bg-primary" style="width: {{ taskBasics.taskCompletionRate }}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {# Goal Performance Section #}
            <div class="col">
                <div class="card shadow-sm h-100">
                    <div class="card-body p-4">
                        <h3 class="mb-4 d-flex align-items-center">
                            <span class="me-2">üéØ</span> Goal Performance
                        </h3>

                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center p-3 bg-warning-subtle rounded mb-3">
                                <span class="fw-semibold">Total Goals</span>
                                <span class="h4 fw-bold text-warning-emphasis mb-0">{{ goalMetrics.totalGoals }}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center p-3 bg-success-subtle rounded mb-3">
                                <span class="fw-semibold">Completed</span>
                                <span class="h4 fw-bold text-success mb-0">{{ goalMetrics.completedGoals }}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center p-3 bg-primary-subtle rounded">
                                <span class="fw-semibold">In Progress</span>
                                <span class="h4 fw-bold text-primary mb-0">{{ goalMetrics.inProgressGoals }}</span>
                            </div>
                        </div>

                        {# Progress Bar #}
                        <div class="mt-4">
                            <div class="d-flex justify-content-between">
                                <span class="small fw-semibold text-success">Goal Completion Progress</span>
                                <span class="small fw-semibold text-success">{{ goalMetrics.completionRate }}%</span>
                            </div>
                            <div class="progress" role="progressbar" aria-label="Goal Completion" aria-valuenow="{{ goalMetrics.completionRate }}" aria-valuemin="0" aria-valuemax="100" style="height: 1rem">
                                <div class="progress-bar bg-success" style="width: {{ goalMetrics.completionRate }}%"></div>
                            </div>
                        </div>

                        <div class="mt-4 p-3 bg-primary-subtle rounded">
                            <div class="small text-muted mb-1">Average Goal Progress</div>
                            <div class="h3 fw-bold text-primary mb-0">{{ goalMetrics.averageProgress }}%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# Time Metrics #}
        <div class="card shadow-sm p-4 mb-5">
            <h3 class="mb-4 d-flex align-items-center">
                <span class="me-2">‚è±Ô∏è</span> Time Performance
            </h3>
            <div class="row row-cols-1 row-cols-md-3 g-4">
                <div class="col">
                    <div class="p-3 bg-info-subtle rounded-3 h-100">
                        <div class="small text-muted mb-1">On-Time Completion</div>
                        <div class="h3 fw-bold text-info-emphasis mb-0">{{ taskBasics.onTimeCompletionRate }}%</div>
                        <div class="small text-muted mt-1">
                            {{ taskBasics.tasksCompletedOnTime }} of {{ taskBasics.completedTasks }} tasks
                        </div>
                    </div>
                </div>

                {% if taskTime.averageCompletionTime is defined and taskTime.averageCompletionTime %}
                    <div class="col">
                        <div class="p-3 bg-primary-subtle rounded-3 h-100">
                            <div class="small text-muted mb-1">Avg. Completion Time</div>
                            <div class="h3 fw-bold text-primary mb-0">
                                {{ taskTime.averageCompletionTime|number_format(1) }}
                            </div>
                            <div class="small text-muted mt-1">hours per task</div>
                        </div>
                    </div>
                {% endif %}

                {% if taskTime.averageDelayHours is defined and taskTime.averageDelayHours %}
                    <div class="col">
                        <div class="p-3 bg-danger-subtle rounded-3 h-100">
                            <div class="small text-muted mb-1">Avg. Delay</div>
                            <div class="h3 fw-bold text-danger mb-0">
                                {{ taskTime.averageDelayHours|number_format(1) }}
                            </div>
                            <div class="small text-muted mt-1">hours when delayed</div>
                        </div>
                    </div>
                {% else %}
                    <div class="col">
                        <div class="p-3 bg-success-subtle rounded-3 h-100">
                            <div class="small text-muted mb-1">Avg. Delay</div>
                            <div class="h3 fw-bold text-success mb-0">0</div>
                            <div class="small text-muted mt-1">No delays recorded</div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        {# Weekly Summary & Recommendations #}
        <div class="card shadow-sm p-4 mb-4">
            <h3 class="mb-4 d-flex align-items-center">
                <span class="me-2">üíº</span> Weekly Summary
            </h3>

            <div class="row row-cols-1 row-cols-md-2 g-4">
                <div class="col">
                    <div class="p-4 bg-success-subtle border border-success-subtle rounded-3 h-100">
                        <h4 class="text-success-emphasis d-flex align-items-center mb-4">
                            <span class="me-2">‚úÖ</span> This Week's Wins
                        </h4>
                        <ul class="list-unstyled mb-0">
                            {% if combinedScore >= 80 %}
                                <li class="d-flex mb-2">
                                    <span class="text-success me-2">‚Ä¢</span>
                                    <span>Excellent overall weekly performance</span>
                                </li>
                            {% endif %}
                            {% if taskBasics.taskCompletionRate >= 75 %}
                                <li class="d-flex mb-2">
                                    <span class="text-success me-2">‚Ä¢</span>
                                    <span>Strong task completion ({{ taskBasics.taskCompletionRate|number_format(1) }}%)</span>
                                </li>
                            {% endif %}
                            {% if goalMetrics.completionRate >= 75 %}
                                <li class="d-flex mb-2">
                                    <span class="text-success me-2">‚Ä¢</span>
                                    <span>Great goal achievement ({{ goalMetrics.completionRate }}%)</span>
                                </li>
                            {% endif %}
                            {% if taskBasics.onTimeCompletionRate >= 80 %}
                                <li class="d-flex mb-2">
                                    <span class="text-success me-2">‚Ä¢</span>
                                    <span>Excellent time management this week</span>
                                </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>

                <div class="col">
                    <div class="p-4 bg-primary-subtle border border-primary-subtle rounded-3 h-100">
                        <h4 class="text-primary-emphasis d-flex align-items-center mb-4">
                            <span class="me-2">üéØ</span> Focus for Next Week
                        </h4>
                        <ul class="list-unstyled mb-0">
                            {% if taskBasics.taskCompletionRate < 75 %}
                                <li class="d-flex mb-2">
                                    <span class="text-primary me-2">‚Ä¢</span>
                                    <span>Improve task completion rate</span>
                                </li>
                            {% endif %}
                            {% if goalMetrics.completionRate < 75 %}
                                <li class="d-flex mb-2">
                                    <span class="text-primary me-2">‚Ä¢</span>
                                    <span>Focus on goal achievement</span>
                                </li>
                            {% endif %}
                            {% if taskBasics.onTimeCompletionRate < 80 %}
                                <li class="d-flex mb-2">
                                    <span class="text-primary me-2">‚Ä¢</span>
                                    <span>Work on timely task delivery</span>
                                </li>
                            {% endif %}
                            <li class="d-flex mb-2">
                                <span class="text-primary me-2">‚Ä¢</span>
                                <span>Set clear priorities for the week ahead</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

    </div>
{% endblock %}
