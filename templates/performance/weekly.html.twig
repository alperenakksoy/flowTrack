{% extends 'base.html.twig' %}

{% block title %}Weekly Performance Report{% endblock %}

{% block stylesheets %}
    <style>
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 2rem;
        }
        .chart-card {
            min-height: 400px;
        }
    </style>
{% endblock %}

{% block body %}

    {% set taskBasics = taskMetrics.basicMetrics %}
    {% set taskTime = taskMetrics.timeMetrics %}
    {% set taskPriority = taskMetrics.priorityMetrics %}

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h1>Weekly Performance Report</h1>
                {% if isOwnPerformance %}
                    <p class="text-muted mb-0">Your Performance - Week {{ week }} - {{ year }}</p>
                {% else %}
                    <p class="text-muted mb-0">
                        {{ targetUser.email }}'s Performance - Week {{ week }} - {{ year }}
                    </p>
                {% endif %}
            </div>
            <div class="d-flex gap-2">
                <a href="{{ path('performance_overall', {id: targetUser.id}) }}" class="btn btn-success">
                    Overall Report
                </a>
                <a href="{{ path('performance_monthly', {id: targetUser.id}) }}" class="btn btn-primary">
                    Monthly Report
                </a>
            </div>
        </div>

        {% if not isOwnPerformance %}
            <div class="alert alert-info d-flex align-items-center mb-4" role="alert">
                <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Info:">
                    <use href="#info-fill"></use>
                </svg>
                <div>
                    Viewing performance report for <strong>{{ targetUser.email }}</strong>
                </div>
            </div>
        {% endif %}

        <div class="text-center text-white bg-primary bg-gradient rounded-3 shadow-lg p-5 mb-5">
            <h2 class="fw-light mb-4">Combined Weekly Performance Score</h2>
            <div class="display-1 fw-bold mb-4">{{ combinedScore|number_format(1) }}%</div>

            {% set scoreLevel = combinedScore %}
            <div class="fs-5 mb-4">
                {% if scoreLevel >= 90 %}
                    <span class="badge rounded-pill fs-6 fw-normal bg-light text-primary p-3">
                        üåü Outstanding Week
                    </span>
                {% elseif scoreLevel >= 75 %}
                    <span class="badge rounded-pill fs-6 fw-normal bg-light text-primary p-3">
                        üëç Strong Week
                    </span>
                {% elseif scoreLevel >= 60 %}
                    <span class="badge rounded-pill fs-6 fw-normal bg-light text-primary p-3">
                        ‚ö†Ô∏è Developing Week
                    </span>
                {% else %}
                    <span class="badge rounded-pill fs-6 fw-normal bg-light text-primary p-3">
                        üìà Growth Opportunity
                    </span>
                {% endif %}
            </div>

            <div class="row row-cols-1 row-cols-md-2 g-4 mt-4">
                <div class="col">
                    <div class="p-3 bg-light bg-opacity-25 rounded-3">
                        <div class="small">Task Performance</div>
                        <div class="display-4 fw-bold">{{ taskScore|number_format(1) }}%</div>
                    </div>
                </div>
                <div class="col">
                    <div class="p-3 bg-light bg-opacity-25 rounded-3">
                        <div class="small">Goal Performance</div>
                        <div class="display-4 fw-bold">{{ goalScore|number_format(1) }}%</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-md-6">
                <div class="card shadow-sm chart-card">
                    <div class="card-body">
                        <h4 class="card-title mb-4">üìä Performance Breakdown</h4>
                        <div class="chart-container">
                            <canvas id="performanceBreakdownChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow-sm chart-card">
                    <div class="card-body">
                        <h4 class="card-title mb-4">üìã Task Distribution</h4>
                        <div class="chart-container">
                            <canvas id="taskStatusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow-sm chart-card">
                    <div class="card-body">
                        <h4 class="card-title mb-4">‚úÖ Completion Rates</h4>
                        <div class="chart-container">
                            <canvas id="completionRatesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow-sm chart-card">
                    <div class="card-body">
                        <h4 class="card-title mb-4">üéØ Goal Status</h4>
                        <div class="chart-container">
                            <canvas id="goalStatusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            {% if taskMetrics.priorityMetrics.completionRateByPriority is defined and taskMetrics.priorityMetrics.completionRateByPriority is not empty %}
                <div class="col-12">
                    <div class="card shadow-sm chart-card">
                        <div class="card-body">
                            <h4 class="card-title mb-4">üéØ Completion Rate by Priority</h4>
                            <div class="chart-container">
                                <canvas id="priorityCompletionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>

        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-5 g-4 mb-5">
            <div class="col">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <div class="text-muted small mb-2">Total Tasks</div>
                        <div class="h1 fw-bold text-primary">{{ taskBasics.totalTasksInPeriod }}</div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <div class="text-muted small mb-2">Completed</div>
                        <div class="h1 fw-bold text-success">{{ taskBasics.completedTasks }}</div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card shadow-sm h-100 border-warning">
                    <div class="card-body">
                        <div class="text-muted small mb-2">Open/In Progress</div>
                        <div class="h1 fw-bold text-warning">{{ taskBasics.openTasks }}</div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <div class="text-muted small mb-2">Completion Rate</div>
                        <div class="h1 fw-bold text-primary">{{ taskBasics.taskCompletionRate|number_format(1) }}%</div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <div class="text-muted small mb-2">On-Time Rate</div>
                        <div class="h1 fw-bold text-info">{{ taskBasics.onTimeCompletionRate }}%</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row row-cols-1 row-cols-lg-2 g-5 mb-5">
            <div class="col">
                <div class="card shadow-sm h-100">
                    <div class="card-body p-4">
                        <h3 class="mb-4 d-flex align-items-center">
                            <span class="me-2">üìã</span> Task Performance
                        </h3>
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center p-3 bg-primary-subtle rounded mb-3">
                                <span class="fw-semibold">Total Tasks</span>
                                <span class="h4 fw-bold text-primary mb-0">{{ taskBasics.totalTasksInPeriod }}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center p-3 bg-success-subtle rounded mb-3">
                                <span class="fw-semibold">Completed</span>
                                <span class="h4 fw-bold text-success mb-0">{{ taskBasics.completedTasks }}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center p-3 bg-warning-subtle rounded mb-3">
                                <span class="fw-semibold">Open/In Progress</span>
                                <span class="h4 fw-bold text-warning-emphasis mb-0">{{ taskBasics.openTasks }}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center p-3 bg-info-subtle rounded">
                                <span class="fw-semibold">On-Time</span>
                                <span class="h4 fw-bold text-info mb-0">{{ taskBasics.tasksCompletedOnTime }}</span>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="d-flex justify-content-between">
                                <span class="small fw-semibold text-primary">Task Completion Progress</span>
                                <span class="small fw-semibold text-primary">{{ taskBasics.taskCompletionRate|number_format(1) }}%</span>
                            </div>
                            <div class="progress" role="progressbar" style="height: 1rem">
                                <div class="progress-bar bg-primary" style="width: {{ taskBasics.taskCompletionRate }}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col">
                <div class="card shadow-sm h-100">
                    <div class="card-body p-4">
                        <h3 class="mb-4 d-flex align-items-center">
                            <span class="me-2">üéØ</span> Goal Performance
                        </h3>
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center p-3 bg-warning-subtle rounded mb-3">
                                <span class="fw-semibold">Total Goals</span>
                                <span class="h4 fw-bold text-warning-emphasis mb-0">{{ goalMetrics.totalGoals }}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center p-3 bg-success-subtle rounded mb-3">
                                <span class="fw-semibold">Completed</span>
                                <span class="h4 fw-bold text-success mb-0">{{ goalMetrics.completedGoals }}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center p-3 bg-primary-subtle rounded">
                                <span class="fw-semibold">In Progress</span>
                                <span class="h4 fw-bold text-primary mb-0">{{ goalMetrics.inProgressGoals }}</span>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="d-flex justify-content-between">
                                <span class="small fw-semibold text-success">Goal Completion Progress</span>
                                <span class="small fw-semibold text-success">{{ goalMetrics.completionRate }}%</span>
                            </div>
                            <div class="progress" role="progressbar" style="height: 1rem">
                                <div class="progress-bar bg-success" style="width: {{ goalMetrics.completionRate }}%"></div>
                            </div>
                        </div>
                        <div class="mt-4 p-3 bg-primary-subtle rounded">
                            <div class="small text-muted mb-1">Average Goal Progress</div>
                            <div class="h3 fw-bold text-primary mb-0">{{ goalMetrics.averageProgress }}%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm p-4 mb-5">
            <h3 class="mb-4 d-flex align-items-center">
                <span class="me-2">‚è±Ô∏è</span> Time Performance
            </h3>
            <div class="row row-cols-1 row-cols-md-3 g-4">
                <div class="col">
                    <div class="p-3 bg-info-subtle rounded-3 h-100">
                        <div class="small text-muted mb-1">On-Time Completion</div>
                        <div class="h3 fw-bold text-info-emphasis mb-0">{{ taskBasics.onTimeCompletionRate }}%</div>
                        <div class="small text-muted mt-1">
                            {{ taskBasics.tasksCompletedOnTime }} of {{ taskBasics.completedTasks }} tasks
                        </div>
                    </div>
                </div>
                {% if taskTime.averageCompletionTime is defined and taskTime.averageCompletionTime %}
                    <div class="col">
                        <div class="p-3 bg-primary-subtle rounded-3 h-100">
                            <div class="small text-muted mb-1">Avg. Completion Time</div>
                            <div class="h3 fw-bold text-primary mb-0">
                                {{ taskTime.averageCompletionTime|number_format(1) }}
                            </div>
                            <div class="small text-muted mt-1">hours per task</div>
                        </div>
                    </div>
                {% endif %}
                {% if taskTime.averageDelayHours is defined and taskTime.averageDelayHours %}
                    <div class="col">
                        <div class="p-3 bg-danger-subtle rounded-3 h-100">
                            <div class="small text-muted mb-1">Avg. Delay</div>
                            <div class="h3 fw-bold text-danger mb-0">
                                {{ taskTime.averageDelayHours|number_format(1) }}
                            </div>
                            <div class="small text-muted mt-1">hours when delayed</div>
                        </div>
                    </div>
                {% else %}
                    <div class="col">
                        <div class="p-3 bg-success-subtle rounded-3 h-100">
                            <div class="small text-muted mb-1">Avg. Delay</div>
                            <div class="h3 fw-bold text-success mb-0">0</div>
                            <div class="small text-muted mt-1">No delays recorded</div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="card shadow-sm p-4 mb-4">
            <h3 class="mb-4 d-flex align-items-center">
                <span class="me-2">üíº</span> Weekly Summary
            </h3>
            <div class="row row-cols-1 row-cols-md-2 g-4">
                <div class="col">
                    <div class="p-4 bg-success-subtle border border-success-subtle rounded-3 h-100">
                        <h4 class="text-success-emphasis d-flex align-items-center mb-4">
                            <span class="me-2">‚úÖ</span> This Week's Wins
                        </h4>
                        <ul class="list-unstyled mb-0">
                            {% if combinedScore >= 80 %}
                                <li class="d-flex mb-2">
                                    <span class="text-success me-2">‚Ä¢</span>
                                    <span>Excellent overall weekly performance</span>
                                </li>
                            {% endif %}
                            {% if taskBasics.taskCompletionRate >= 75 %}
                                <li class="d-flex mb-2">
                                    <span class="text-success me-2">‚Ä¢</span>
                                    <span>Strong task completion ({{ taskBasics.taskCompletionRate|number_format(1) }}%)</span>
                                </li>
                            {% endif %}
                            {% if goalMetrics.completionRate >= 75 %}
                                <li class="d-flex mb-2">
                                    <span class="text-success me-2">‚Ä¢</span>
                                    <span>Great goal achievement ({{ goalMetrics.completionRate }}%)</span>
                                </li>
                            {% endif %}
                            {% if taskBasics.onTimeCompletionRate >= 80 %}
                                <li class="d-flex mb-2">
                                    <span class="text-success me-2">‚Ä¢</span>
                                    <span>Excellent time management this week</span>
                                </li>
                            {% endif %}
                            {% if taskBasics.openTasks == 0 %}
                                <li class="d-flex mb-2">
                                    <span class="text-success me-2">‚Ä¢</span>
                                    <span>All tasks completed‚Äîno pending work!</span>
                                </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
                <div class="col">
                    <div class="p-4 bg-primary-subtle border border-primary-subtle rounded-3 h-100">
                        <h4 class="text-primary-emphasis d-flex align-items-center mb-4">
                            <span class="me-2">üéØ</span> Focus for Next Week
                        </h4>
                        <ul class="list-unstyled mb-0">
                            {% if taskBasics.openTasks > 0 %}
                                <li class="d-flex mb-2">
                                    <span class="text-primary me-2">‚Ä¢</span>
                                    <span>Complete {{ taskBasics.openTasks }} pending task(s)</span>
                                </li>
                            {% endif %}
                            {% if taskBasics.taskCompletionRate < 75 %}
                                <li class="d-flex mb-2">
                                    <span class="text-primary me-2">‚Ä¢</span>
                                    <span>Improve task completion rate</span>
                                </li>
                            {% endif %}
                            {% if goalMetrics.completionRate < 75 %}
                                <li class="d-flex mb-2">
                                    <span class="text-primary me-2">‚Ä¢</span>
                                    <span>Focus on goal achievement</span>
                                </li>
                            {% endif %}
                            {% if taskBasics.onTimeCompletionRate < 80 %}
                                <li class="d-flex mb-2">
                                    <span class="text-primary me-2">‚Ä¢</span>
                                    <span>Work on timely task delivery</span>
                                </li>
                            {% endif %}
                            <li class="d-flex mb-2">
                                <span class="text-primary me-2">‚Ä¢</span>
                                <span>Set clear priorities for the week ahead</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

    </div>
{% endblock %}
{% block javascripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        Chart.defaults.font.family = 'system-ui, -apple-system, "Segoe UI", Roboto, sans-serif';
        Chart.defaults.color = '#6c757d';

        new Chart(document.getElementById('performanceBreakdownChart'), {
            type: 'bar',
            data: {
                labels: ['Task Score', 'Goal Score', 'Combined Score'],
                datasets: [{
                    label: 'Performance Score (%)',
                    data: [{{ taskScore|default(0) }}, {{ goalScore|default(0) }}, {{ combinedScore|default(0) }}],
                    backgroundColor: ['rgba(13, 110, 253, 0.8)', 'rgba(25, 135, 84, 0.8)', 'rgba(111, 66, 193, 0.8)'],
                    borderColor: ['rgb(13, 110, 253)', 'rgb(25, 135, 84)', 'rgb(111, 66, 193)'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: ctx => ctx.parsed.y.toFixed(1) + '%' } }
                }
            }
        });

        // 2. Task Status Distribution
        new Chart(document.getElementById('taskStatusChart'), {
            type: 'doughnut',
            data: {
                labels: ['Completed', 'Open/In Progress'],
                datasets: [{
                    data: [{{ taskMetrics.basicMetrics.completedTasks|default(0) }}, {{ taskMetrics.basicMetrics.openTasks|default(0) }}],
                    backgroundColor: ['rgba(25, 135, 84, 0.8)', 'rgba(255, 193, 7, 0.8)'],
                    borderColor: ['rgb(25, 135, 84)', 'rgb(255, 193, 7)'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: ctx => {
                                const total = {{ taskMetrics.basicMetrics.totalTasksInPeriod|default(0) }};
                                const pct = total > 0 ? ((ctx.parsed / total) * 100).toFixed(1) : 0;
                                return ctx.label + ': ' + ctx.parsed + ' (' + pct + '%)';
                            }
                        }
                    }
                }
            }
        });

        // 3. Completion Rates
        new Chart(document.getElementById('completionRatesChart'), {
            type: 'bar',
            data: {
                labels: ['Task Completion', 'On-Time Completion', 'Goal Completion'],
                datasets: [{
                    label: 'Rate (%)',
                    data: [{{ taskMetrics.basicMetrics.taskCompletionRate|default(0) }}, {{ taskMetrics.basicMetrics.onTimeCompletionRate|default(0) }}, {{ goalMetrics.completionRate|default(0) }}],
                    backgroundColor: ['rgba(13, 110, 253, 0.8)', 'rgba(13, 202, 240, 0.8)', 'rgba(25, 135, 84, 0.8)'],
                    borderColor: ['rgb(13, 110, 253)', 'rgb(13, 202, 240)', 'rgb(25, 135, 84)'],
                    borderWidth: 2
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: ctx => ctx.parsed.x.toFixed(1) + '%' } }
                }
            }
        });

        new Chart(document.getElementById('goalStatusChart'), {
            type: 'pie',
            data: {
                labels: ['Completed', 'In Progress', 'Not Started'],
                datasets: [{
                    data: [{{ goalMetrics.completedGoals|default(0) }}, {{ goalMetrics.inProgressGoals|default(0) }}, {{ (goalMetrics.totalGoals|default(0)) - (goalMetrics.completedGoals|default(0)) - (goalMetrics.inProgressGoals|default(0)) }}],
                    backgroundColor: ['rgba(25, 135, 84, 0.8)', 'rgba(13, 110, 253, 0.8)', 'rgba(108, 117, 125, 0.8)'],
                    borderColor: ['rgb(25, 135, 84)', 'rgb(13, 110, 253)', 'rgb(108, 117, 125)'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: ctx => {
                                const total = {{ goalMetrics.totalGoals|default(0) }};
                                const pct = total > 0 ? ((ctx.parsed / total) * 100).toFixed(1) : 0;
                                return ctx.label + ': ' + ctx.parsed + ' (' + pct + '%)';
                            }
                        }
                    }
                }
            }
        });

        {% if taskMetrics.priorityMetrics.completionRateByPriority is defined and taskMetrics.priorityMetrics.completionRateByPriority is not empty %}
        new Chart(document.getElementById('priorityCompletionChart'), {
            type: 'bar',
            data: {
                labels: ['Low Priority', 'Medium Priority', 'High Priority'],
                datasets: [{
                    label: 'Completion Rate (%)',
                    data: [
                        {{ taskMetrics.priorityMetrics.completionRateByPriority[1]|default(0) }},
                        {{ taskMetrics.priorityMetrics.completionRateByPriority[2]|default(0) }},
                        {{ taskMetrics.priorityMetrics.completionRateByPriority[3]|default(0) }}
                    ],
                    backgroundColor: ['rgba(13, 202, 240, 0.8)', 'rgba(255, 193, 7, 0.8)', 'rgba(220, 53, 69, 0.8)'],
                    borderColor: ['rgb(13, 202, 240)', 'rgb(255, 193, 7)', 'rgb(220, 53, 69)'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: ctx => 'Completion: ' + ctx.parsed.y.toFixed(1) + '%' } }
                }
            }
        });
        {% endif %}
    </script>
{% endblock %}
